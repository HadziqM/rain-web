name: 'Rain-Web'
on:
    push:
        branches:
            - development
    pull_request:
        branches:
            - main
            - development

jobs:
    rain-web-deploy:
        runs-on: ubuntu-latest
        env:
            VITE_DATABASE_URL: ${{ secrets.DATABASE_URL }}

        steps:
            - name: Checkout
              uses: actions/checkout@v3

            - name: Install Node.js
              uses: actions/setup-node@v3
              with:
                  node-version: 16

            - uses: pnpm/action-setup@v2
              name: Install pnpm
              id: pnpm-install
              with:
                  version: 7
                  run_install: false

            - name: Install dependencies
              run: pnpm i
            - run: npx prisma generate --schema=./prisma/schema.prisma --data-proxy

            - name: Build
              run: pnpm build

            - name: Deploy on Cloudflare Development
              if: contains(toJSON(github.ref), 'development')
              uses: cloudflare/wrangler-action@2.0.0
              with:
                  apiToken: ${{ secrets.CF_API_TOKEN }}
                  accountId: ${{ secrets.CF_ACCOUNT_ID }}
                  command: publish --name development

            - name: Deploy on Cloudflare Production
              if: contains(toJSON(github.ref), 'main')
              uses: cloudflare/wrangler-action@2.0.0
              with:
                  apiToken: ${{ secrets.CF_API_TOKEN }}
                  accountId: ${{ secrets.CF_ACCOUNT_ID }}
                  command: publish --name production
